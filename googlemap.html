<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rute Dinamis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);

      const getLatLng = (key) => {
        const val = urlParams.get(key);
        if (!val) return null;
        const [lat, lng] = val.split(',').map(Number);
        return (!isNaN(lat) && !isNaN(lng)) ? { lat, lng } : null;
      };

      const from = getLatLng("from");
      const to = getLatLng("to");
      const order = getLatLng("order");
      const vehicle = urlParams.get("vehicle") || "mobil";
      const apiKey = urlParams.get("token");

      const iconUrls = {
        motor: "https://cdn-icons-png.flaticon.com/128/5811/5811823.png",
        mobil: "https://cdn-icons-png.flaticon.com/128/12689/12689302.png",
        kurir: "https://cdn-icons-png.flaticon.com/128/9561/9561688.png",
      };

      let map, directionsService, directionsRenderer;

      function hitungJarak(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: from || { lat: -6.2, lng: 106.8 },
          zoom: 14,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        directionsRenderer.setMap(map);

        if (from && to) {
          directionsService.route(
            {
              origin: from,
              destination: to,
              travelMode: google.maps.TravelMode.DRIVING,
            },
            (response, status) => {
              if (status === "OK") {
                directionsRenderer.setDirections(response);

                const aMarker = new google.maps.Marker({
                  position: from,
                  map,
                  icon: {
                    url: iconUrls[vehicle] || iconUrls.mobil,
                    scaledSize: new google.maps.Size(40, 40),
                  },
                });

                const bMarker = new google.maps.Marker({
                  position: to,
                  map,
                });

                if (order) {
                  const jarak = hitungJarak(order.lat, order.lng, from.lat, from.lng);
                  const label = jarak < 1 ? `${(jarak * 1000).toFixed(0)} m` : `${jarak.toFixed(2)} km`;
                  const popup = new google.maps.InfoWindow({ content: `Dari order: ${label}` });
                  popup.open(map, aMarker);
                }

                const hasil = {
                  jarak: response.routes[0].legs[0].distance.text,
                  durasi: response.routes[0].legs[0].duration.text
                };

                if (window.AppInventor) {
                  window.AppInventor.setWebViewString(JSON.stringify(hasil));
                }

              } else {
                alert("Gagal menghitung rute: " + status);
              }
            }
          );
        } else {
          alert("Koordinat from dan to tidak lengkap");
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEsbn9W4ivUesB15wmDuMhOT4JR6Mq9Bs&libraries=places&callback=initMap"
      async defer
    ></script>
  </body>
</html>